debian:
  image: debian:testing
  stage: build
  artifacts:
    expire_in: 1 week
    paths:
      - build
  script:
    - apt update
    - apt full-upgrade -y
    - apt install meson gcc valac gobject-introspection --no-install-recommends -y
    - apt install libarchive-dev libreadline-dev libcurl4-openssl-dev libbrotli-dev libmagic-dev --no-install-recommends -y
    - meson build -Ddebug=true -Dtools=true -Dlibbrotli=false -Dlibmagic=true -Dtest=true -Dshared=true
    - ninja -C build
    - cd build && timeout 30 ./ymp-test || true
    - ninja install

archlinux:
  image: archlinux:latest
  stage: build
  artifacts:
    expire_in: 1 week
    paths:
      - build
  script:
    - pacman -Syyu --noconfirm
    - pacman -Sy gcc vala gobject-introspection --noconfirm
    - pacman -Sy meson curl libarchive readline file --noconfirm
    - meson build -Ddebug=true -Dtools=true  -Dtest=true -Dshared=true -Dlibmagic=true 
    - ninja -C build
    - cd build && timeout 30 ./ymp-test || true
    - ninja install

alpine:
  image: alpine:edge
  stage: build
  artifacts:
    expire_in: 1 week
    paths:
      - build
  script:
    - apk update
    - apk add meson musl-dev gcc bash vala glib-dev readline-dev libarchive-dev libcurl curl-dev upx file-dev libmagic
    - apk add libarchive readline glib zlib ncurses acl expat openssl-libs xz-dev zstd lz4 bzip2 curl brotli nghttp2
    - meson build -Ddebug=false -Dshared=true -Dtools=true -Dtest=true -Dlibmagic=true 
    - ninja -C build
    - upx -9 build/* || true
    - cd build && timeout 30 ./ymp-test || true
    - ninja install
